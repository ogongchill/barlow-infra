AWSTemplateFormatVersion: 2010-09-09
Description: Test environment - EC2 Spot + RDS from snapshot

Parameters:
  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: VPC where resources will be launched

  Ec2SubnetId:
    Type: AWS::EC2::Subnet::Id
    Description: Public subnet for EC2 instance

  RdsSubnetIds:
    Type: List<AWS::EC2::Subnet::Id>
    Description: Minimum subnets for RDS (minimum 2 AZs)

  InstanceType:
    Type: String
    Default: t3.small
    AllowedValues:
      - t3.micro
      - t3.small
      - t3.medium

  KeyName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: SSH key pair name

  AllowedCidr:
    Type: String
    Default: 0.0.0.0/0
    Description: CIDR allowed for SSH and app access

  AmiId:
    Type: AWS::EC2::Image::Id
    Description: AMI ID for EC2 instance

  JarS3Path:
    Type: String
    Description: S3 path to app.jar (e.g. s3://bucket/path/app.jar)

  DBSnapshotIdentifier:
    Type: String
    Description: RDS snapshot ARN or identifier to restore from

  DBInstanceClass:
    Type: String
    Default: db.t4g.micro
    AllowedValues:
      - db.t4g.micro 
      - db.t3.micro
      - db.t3.small
      - db.t3.medium

Resources:
  # ---- EC2 Security Group ----
  EC2SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow SSH and 8080
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref AllowedCidr
        - IpProtocol: tcp
          FromPort: 8080
          ToPort: 8080
          CidrIp: !Ref AllowedCidr
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: test-ec2-sg
        - Key: env
          Value: test

  # ---- RDS Security Group ----
  RDSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow MySQL from EC2 and external access
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref EC2SecurityGroup
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          CidrIp: !Ref AllowedCidr
      Tags:
        - Key: Name
          Value: test-rds-sg
        - Key: env
          Value: test

  # ---- EC2 IAM Role ----
  EC2Role:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess
      Policies:
        - PolicyName: EC2AppPolicy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action: cloudformation:SignalResource
                Resource: !Sub arn:aws:cloudformation:${AWS::Region}:${AWS::AccountId}:stack/${AWS::StackName}/*
              - Effect: Allow
                Action: ssm:GetParameter
                Resource: !Sub arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/barlow/staging/slack-webhook-url

  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref EC2Role

  # ---- EC2 Spot Instance ----
  SpotLaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateData:
        IamInstanceProfile:
          Arn: !GetAtt EC2InstanceProfile.Arn
        InstanceMarketOptions:
          MarketType: spot
          SpotOptions:
            SpotInstanceType: one-time
            InstanceInterruptionBehavior: terminate
        NetworkInterfaces:
          - DeviceIndex: 0
            AssociatePublicIpAddress: true
            SubnetId: !Ref Ec2SubnetId
            Groups:
              - !Ref EC2SecurityGroup
        UserData:
          Fn::Base64: !Sub |
            #!/bin/bash -xe
            # 0. 환경변수 등록 (AMI .profile의 기존값 override)
            echo "export STORAGE_DATABASE_CORE_DB_URL=${TestDBInstance.Endpoint.Address}:3306" >> /home/ubuntu/.profile
            echo "export JAR_S3_PATH=${JarS3Path}" >> /home/ubuntu/.profile
            source /home/ubuntu/.profile
            RDS_ADDRESS=$(echo $STORAGE_DATABASE_CORE_DB_URL | cut -d: -f1)

            INSTANCE_ID=$(cat /var/lib/cloud/data/instance-id)
            PUBLIC_IP=$(curl -sf http://169.254.169.254/latest/meta-data/public-ipv4 || echo "unknown")
            SLACK_WEBHOOK_URL=$(aws ssm get-parameter \
              --name "/barlow/staging/slack-webhook-url" \
              --with-decryption \
              --query "Parameter.Value" \
              --output text \
              --region ${AWS::Region})

            # 배포 실패 시 알림
            trap '
              trap "" ERR
              aws cloudformation signal-resource \
                --stack-name ${AWS::StackName} \
                --logical-resource-id SpotInstance \
                --unique-id $INSTANCE_ID \
                --status FAILURE \
                --region ${AWS::Region}
              curl -sf -X POST "$SLACK_WEBHOOK_URL" \
                -H "Content-Type: application/json" \
                -d "{
                  \"text\": \"*[TEST] 스택 배포 실패*\",
                  \"attachments\": [{
                    \"color\": \"danger\",
                    \"fields\": [
                      {\"title\": \"Stack\",  \"value\": \"${AWS::StackName}\", \"short\": true},
                      {\"title\": \"Region\", \"value\": \"${AWS::Region}\",    \"short\": true}
                    ]
                  }]
                }"
            ' ERR

            # 1. RDS connection test
            for i in $(seq 1 30); do
              nc -z $RDS_ADDRESS 3306 && break
              sleep 10
            done

            # 2. Download jar from S3
            aws s3 cp $JAR_S3_PATH /home/ubuntu/barlow-server/app.jar

            # 3. Run app
            bash /home/ubuntu/barlow-server/deploy.sh

            # 4. Health check
            for i in $(seq 1 30); do
              curl -sf http://localhost:8080/api/v1/health && break
              sleep 10
            done

            # 5. Signal CloudFormation
            aws cloudformation signal-resource \
              --stack-name ${AWS::StackName} \
              --logical-resource-id SpotInstance \
              --unique-id $INSTANCE_ID \
              --status SUCCESS \
              --region ${AWS::Region}

            # 6. Slack 성공 알림
            curl -sf -X POST "$SLACK_WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              -d "{
                \"text\": \"*[TEST] 스택 배포 완료*\",
                \"attachments\": [{
                  \"color\": \"good\",
                  \"fields\": [
                    {\"title\": \"Stack\",    \"value\": \"${AWS::StackName}\", \"short\": true},
                    {\"title\": \"Region\",   \"value\": \"${AWS::Region}\",    \"short\": true},
                    {\"title\": \"Test URL\", \"value\": \"http://$PUBLIC_IP:8080/api/v1/health\", \"short\": false},
                    {\"title\": \"RDS\",      \"value\": \"$RDS_ADDRESS:3306\", \"short\": false}
                  ]
                }]
              }"

  SpotInstance:
    Type: AWS::EC2::Instance
    DependsOn: TestDBInstance
    CreationPolicy:
      ResourceSignal:
        Timeout: PT15M
    Properties:
      LaunchTemplate:
        LaunchTemplateId: !Ref SpotLaunchTemplate
        Version: !GetAtt SpotLaunchTemplate.LatestVersionNumber
      ImageId: !Ref AmiId
      InstanceType: !Ref InstanceType
      KeyName: !Ref KeyName
      Tags:
        - Key: Name
          Value: test-spot-instance
        - Key: env
          Value: test

  # ---- RDS from Snapshot ----
  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnets for test RDS
      SubnetIds: !Ref RdsSubnetIds
      Tags:
        - Key: Name
          Value: test-db-subnet-group
        - Key: env
          Value: test

  TestDBInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      DBSnapshotIdentifier: !Ref DBSnapshotIdentifier
      DBInstanceClass: !Ref DBInstanceClass
      DBSubnetGroupName: !Ref DBSubnetGroup
      VPCSecurityGroups:
        - !Ref RDSSecurityGroup
      PubliclyAccessible: true
      MultiAZ: false
      Tags:
        - Key: Name
          Value: test-rds-instance
        - Key: env
          Value: test

  # ---- Auto Cleanup on EC2 Terminate ----
  CleanupLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: DeleteStackPolicy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - cloudformation:DeleteStack
                Resource: !Sub arn:aws:cloudformation:${AWS::Region}:${AWS::AccountId}:stack/${AWS::StackName}/*
              - Effect: Allow
                Action:
                  - ec2:*
                  - rds:*
                  - logs:*
                Resource: "*"

  CleanupLambda:
    Type: AWS::Lambda::Function
    Properties:
      Runtime: python3.12
      Handler: index.handler
      Role: !GetAtt CleanupLambdaRole.Arn
      Timeout: 10
      Environment:
        Variables:
          STACK_NAME: !Ref AWS::StackName
      Code:
        ZipFile: |
          import boto3, os
          def handler(event, context):
              stack = os.environ['STACK_NAME']
              boto3.client('cloudformation').delete_stack(StackName=stack)
              return {'status': 'deleting', 'stack': stack}

  CleanupLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref CleanupLambda
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt CleanupRule.Arn

  CleanupRule:
    Type: AWS::Events::Rule
    Properties:
      Description: Delete stack when EC2 spot instance is terminated
      EventPattern:
        source:
          - aws.ec2
        detail-type:
          - EC2 Instance State-change Notification
        detail:
          state:
            - terminated
          instance-id:
            - !Ref SpotInstance
      Targets:
        - Arn: !GetAtt CleanupLambda.Arn
          Id: CleanupTarget

Outputs:
  InstanceId:
    Description: EC2 Instance Id
    Value: !Ref SpotInstance

  PublicIp:
    Description: Public IP of EC2
    Value: !GetAtt SpotInstance.PublicIp

  TestUrl:
    Description: Test server URL
    Value: !Sub "http://${SpotInstance.PublicIp}:8080/api/v1/health"

  RDSEndpoint:
    Description: RDS endpoint
    Value: !GetAtt TestDBInstance.Endpoint.Address

  RDSPort:
    Description: RDS port
    Value: !GetAtt TestDBInstance.Endpoint.Port
